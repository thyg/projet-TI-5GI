<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webmapping Cameroun - 5GI</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        #map { height: 100vh; width: 100%; background: #cce3f0; /* Fond bleu eau pour faire ressortir la terre */ }
        
        .info-panel {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3); width: 280px;
        }
        
        h3 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        select, input { width: 95%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        .legend { margin-top: 15px; font-size: 0.9em; line-height: 1.5em; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .color-box { width: 20px; height: 20px; margin-right: 10px; border: 1px solid #999; }

        /* Style de la popup */
        .popup-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .popup-table td { padding: 3px; border-bottom: 1px solid #eee; }
        .popup-header { background: #2c3e50; color: white; padding: 5px; text-align: center; border-radius: 3px; }
        
        /* Style des √©tiquettes (noms des d√©partements) */
        .dept-label {
            background: transparent;
            border: none;
            box-shadow: none;
            font-size: 10px;
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 0 #fff;
        }
    </style>
</head>
<body>

    <div class="info-panel">
        <h3>üá®üá≤ SIG Cameroun</h3>
        
        <!-- Recherche Intelligente -->
        <label>üîç Rechercher :</label>
        <input type="text" id="search-input" list="dept-list" placeholder="Tapez un nom..." onchange="searchDept()">
        <datalist id="dept-list">
            <!-- Cette liste sera remplie automatiquement par JavaScript -->
        </datalist>
        
        <!-- Filtres -->
        <label>üìä Th√©matique :</label>
        <select id="mode" onchange="updateMap()">
            <option value="agriculture">üå± Agriculture</option>
            <option value="elevage">üêÑ √âlevage</option>
            <option value="peche">üêü P√™che</option>
        </select>

        <div id="legend" class="legend"></div>
        <div style="margin-top:10px; font-size:0.8em; color:#777;">
            <i>Astuce : Passez la souris sur une zone pour voir son nom.</i>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Zoom initial
        var map = L.map('map').setView([5, 12], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

        var geojsonLayer;
        var globalData;

        // --- NOUVELLES COULEURS (Plus contrast√©es) ---
        function getColor(val, mode) {
            if (mode === 'peche') {
                // Si pas de p√™che (0), on met du gris clair transparent
                return val > 10000 ? '#08519c' : // Bleu fonc√©
                       val > 5000  ? '#3182bd' :
                       val > 1000  ? '#6baed6' :
                       val > 0     ? '#bdd7e7' : 
                                     '#f0f0f0'; // Gris (Pas de p√™che)
            }
            if (mode === 'agriculture') {
                return val > 22000 ? '#00441b' : // Vert tr√®s sombre
                       val > 18000 ? '#006d2c' :
                       val > 14000 ? '#41ae76' :
                       val > 10000 ? '#99d8c9' : 
                                     '#e5f5f9'; // Vert tr√®s clair
            }
            // Elevage
            return val > 45000 ? '#7f0000' : // Rouge sombre
                   val > 30000 ? '#d7301f' :
                   val > 15000 ? '#fc8d59' :
                   val > 5000  ? '#fdcc8a' : 
                                 '#fff7ec'; // Orange p√¢le
        }

        function style(feature) {
            var mode = document.getElementById('mode').value;
            var val = 0;
            
            if (mode === 'agriculture') val = feature.properties.vol_agri_1;
            if (mode === 'elevage') val = feature.properties.vol_elev_1;
            if (mode === 'peche') val = feature.properties.vol_peche;

            // Si c'est le mode P√™che et que la valeur est 0, on change le style
            var isEmpty = (mode === 'peche' && val === 0);

            return {
                fillColor: getColor(val, mode),
                weight: 1, // √âpaisseur de la bordure
                opacity: 1,
                color: '#555', // Couleur de la bordure (Gris fonc√© pour bien d√©limiter)
                fillOpacity: isEmpty ? 0.3 : 0.8 // Plus transparent si vide
            };
        }

        function onEachFeature(feature, layer) {
            var p = feature.properties;

            // 1. AJOUT DU TOOLTIP (Nom qui s'affiche au survol)
            layer.bindTooltip(p.nom, {
                permanent: false, // Change en true si tu veux que ce soit toujours affich√©
                direction: "center",
                className: "dept-label"
            });
            
            // 2. Remplissage de la liste de recherche
            var option = document.createElement('option');
            option.value = p.nom;
            document.getElementById('dept-list').appendChild(option);
            
            // 3. Popup d√©taill√©e
            var content = `
                <div style="min-width:200px">
                    <div class="popup-header">${p.nom} (${p.region})</div>
                    <table class="popup-table" style="margin-top:5px">
                        <tr><td colspan="2"><b>üå± Agriculture</b></td></tr>
                        <tr><td>${p.agri_1}</td><td><b>${p.vol_agri_1} T</b></td></tr>
                        <tr><td>${p.agri_2}</td><td>${p.vol_agri_2} T</td></tr>
                        
                        <tr><td colspan="2" style="border-top:1px solid #ccc"><b>üêÑ √âlevage</b></td></tr>
                        <tr><td>${p.elev_1}</td><td><b>${p.vol_elev_1}</b></td></tr>
                        
                        <tr><td colspan="2" style="border-top:1px solid #ccc"><b>üêü P√™che</b></td></tr>
                        <tr><td colspan="2">${p.vol_peche > 0 ? p.peche_type + " ("+p.vol_peche+" T)" : "<i>N√©ant</i>"}</td></tr>
                    </table>
                </div>
            `;
            layer.bindPopup(content);
        }

        fetch('http://127.0.0.1:5000/api/donnees')
            .then(res => res.json())
            .then(data => {
                globalData = data;
                updateMap();
                var bounds = L.geoJSON(data).getBounds();
                map.fitBounds(bounds);
            });

        function updateMap() {
            if (geojsonLayer) map.removeLayer(geojsonLayer);
            
            geojsonLayer = L.geoJSON(globalData, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);

            updateLegend();
        }

        // --- NOUVELLE FONCTION DE RECHERCHE ---
        function searchDept() {
            var searchVal = document.getElementById('search-input').value.toLowerCase();
            var found = false;

            geojsonLayer.eachLayer(function(layer) {
                var name = layer.feature.properties.nom.toLowerCase();
                
                // Utilisation de 'includes' pour trouver m√™me si on tape une partie du nom
                if (name.includes(searchVal) && searchVal.length > 2) {
                    map.fitBounds(layer.getBounds());
                    layer.openPopup();
                    layer.setStyle({color: 'yellow', weight: 4, fillOpacity: 1});
                    found = true;
                } else {
                    geojsonLayer.resetStyle(layer);
                }
            });

            if(!found && searchVal.length > 2) {
                console.log("D√©partement non trouv√©");
            }
        }

        function updateLegend() {
            var mode = document.getElementById('mode').value;
            var div = document.getElementById('legend');
            var grades, labels;

            if(mode === 'agriculture') {
                div.innerHTML = "<b>Agri (Tonnes)</b><br>";
                grades = [0, 10000, 14000, 18000, 22000];
            } else if (mode === 'peche') {
                 div.innerHTML = "<b>P√™che (Tonnes)</b><br>";
                 grades = [0, 1, 1000, 5000, 10000];
            } else {
                div.innerHTML = "<b>√âlevage (T√™tes)</b><br>";
                grades = [0, 5000, 15000, 30000, 45000];
            }

            for (var i = 0; i < grades.length; i++) {
                var val = grades[i] + 1;
                div.innerHTML +=
                    '<div class="legend-item"><i class="color-box" style="background:' + getColor(val, mode) + '"></i> ' +
                    (grades[i] === 0 ? "Faible / Nul" : "> " + grades[i]) +
                    '</div>';
            }
        }
    </script>
</body>
</html>
